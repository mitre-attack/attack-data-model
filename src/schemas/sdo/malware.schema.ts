import { z } from 'zod/v4';
import {
  createFirstAliasRefinement,
  createFirstXMitreAliasRefinement,
} from '../../refinements/index.js';
import { attackBaseDomainObjectSchema } from '../common/index.js';
import {
  aliasesSchema,
  createAttackExternalReferencesSchema,
  createMultiStixTypeValidator,
  createOldMitreAttackIdSchema,
  createStixIdValidator,
  createStixTypeValidator,
  descriptionSchema,
  emptyStixListErrorMessage,
  ImplementationLanguageOV,
  killChainPhaseSchema,
  MalwareCapabilityOV,
  MalwareTypeOV,
  ProcessorArchitectureOV,
  stixCreatedByRefSchema,
  stixTimestampSchema,
  xMitreContributorsSchema,
  xMitreDomainsSchema,
  xMitreModifiedByRefSchema,
  xMitrePlatformsSchema,
} from '../common/property-schemas/index.js';

//==============================================================================
//
// file and artifact type for sample_refs
//
//==============================================================================

export const stixFileType = createStixIdValidator('file').register(z.globalRegistry, {
  description: 'Used to specify the file stixType of the sample_refs property.',
});

export const stixArtifactType = createStixIdValidator('artifact').register(z.globalRegistry, {
  description: 'Used to specify the artifact stixType of the sample_refs property.',
});

//==============================================================================
//
// Malware Schema
//
//==============================================================================

export const malwareSchema = attackBaseDomainObjectSchema
  .extend({
    id: createStixIdValidator('malware'),

    type: createStixTypeValidator('malware'),

    created_by_ref: stixCreatedByRefSchema.register(z.globalRegistry, {
      description: 'The ID of the Source object that describes who created this object.',
      usage: 'inherit',
      status: 'inherit',
      examples: [],
    }),

    description: descriptionSchema.register(z.globalRegistry, {
      description: 'A description that provides more details and context about the Malware.',
      usage: 'required', // Optional in STIX, required in ATT&CK
      status: 'active',
      examples: ['This is a description of the malware.'],
    }),

    // Malware: Required
    // Tool: Optional
    x_mitre_platforms: xMitrePlatformsSchema.optional().register(z.globalRegistry, {
      description: 'The platforms that the malware targets.',
      usage: 'extension',
      status: 'active',
      examples: [],
    }),

    x_mitre_contributors: xMitreContributorsSchema.optional().register(z.globalRegistry, {
      description: 'People and organizations who have contributed to this object.',
      usage: 'extension',
      status: 'active',
      examples: [],
    }),

    x_mitre_aliases: aliasesSchema.optional().register(z.globalRegistry, {
      description:
        "Alternative names used to identify this software. The first alias must match the object's name.",
      usage: 'extension',
      status: 'active',
      examples: [],
    }),

    x_mitre_modified_by_ref: xMitreModifiedByRefSchema.register(z.globalRegistry, {
      description: 'The STIX ID of the identity that last modified this object.',
      usage: 'extension',
      status: 'active',
      examples: ['identity--c78cb6e5-0c4b-4611-8297-d1b8b55e40b5'],
    }),

    x_mitre_domains: xMitreDomainsSchema.register(z.globalRegistry, {
      description: 'The ATT&CK domains this object belongs to.',
      usage: 'extension',
      status: 'active',
      examples: [['enterprise-attack'], ['mobile-attack'], ['ics-attack']],
    }),

    aliases: aliasesSchema.optional().register(z.globalRegistry, {
      description: 'Alternative names used to identify this software.',
      usage: 'unused', // Not used in ATT&CK Malware but defined in STIX
      status: 'inherit',
      examples: [],
    }),

    is_family: z.boolean().register(z.globalRegistry, {
      description:
        'Whether the object represents a malware family (if true) or a malware instance (if false)',
      usage: 'inherit',
      status: 'inherit',
      examples: [],
    }),

    malware_types: z
      .array(MalwareTypeOV)
      .min(1, { error: emptyStixListErrorMessage })
      .optional()
      .register(z.globalRegistry, {
        description: 'A set of categorizations for the malware being described.',
        usage: 'unused', // Not used in ATT&CK Malware but defined in STIX
        status: 'inherit',
        examples: [],
      }),

    kill_chain_phases: z
      .array(killChainPhaseSchema)
      .min(1, { error: emptyStixListErrorMessage })
      .optional()
      .register(z.globalRegistry, {
        description: 'The list of Kill Chain Phases for which this malware can be used.',
        usage: 'unused', // Not used in ATT&CK Malware but defined in STIX
        status: 'inherit',
        examples: [],
      }),

    first_seen: stixTimestampSchema.optional().register(z.globalRegistry, {
      description: 'The time that this malware instance or malware family was first seen.',
      usage: 'unused', // Not used in ATT&CK Malware but defined in STIX
      status: 'inherit',
      examples: [],
    }),

    last_seen: stixTimestampSchema.optional().register(z.globalRegistry, {
      description: 'The time that this malware family or malware instance was last seen.',
      usage: 'unused', // Not used in ATT&CK Malware but defined in STIX
      status: 'inherit',
      examples: [],
    }),

    external_references: createAttackExternalReferencesSchema('malware').register(
      z.globalRegistry,
      {
        description: 'A list of external references which refers to non-STIX information.',
        usage: 'required', // Optional in STIX, required in ATT&CK
        status: 'inherit',
        examples: [],
      },
    ),

    x_mitre_old_attack_id: createOldMitreAttackIdSchema('malware')
      .optional()
      .register(z.globalRegistry, {
        description: 'Old ATT&CK IDs that have been replaced by the current ATT&CK ID.',
        usage: 'extension',
        status: 'deprecated',
        examples: ['MOB-S0012'],
      }),

    architecture_execution_envs: z
      .array(ProcessorArchitectureOV)
      .min(1, { error: emptyStixListErrorMessage })
      .optional()
      .register(z.globalRegistry, {
        description:
          'The processor architectures (e.g., x86, ARM, etc.) that the malware instance or family is executable on.',
        usage: 'unused', // Not used in ATT&CK Malware but defined in STIX
        status: 'inherit',
        examples: [],
      }),

    implementation_languages: z
      .array(ImplementationLanguageOV)
      .min(1, { error: emptyStixListErrorMessage })
      .optional()
      .register(z.globalRegistry, {
        description:
          'The programming language(s) used to implement the malware instance or family.',
        usage: 'unused', // Not used in ATT&CK Malware but defined in STIX
        status: 'inherit',
        examples: [],
      }),

    capabilities: z.array(MalwareCapabilityOV).min(1).optional().register(z.globalRegistry, {
      description: 'Any of the capabilities identified for the malware instance or family.',
      usage: 'unused', // Not used in ATT&CK Malware but defined in STIX
      status: 'inherit',
      examples: [],
    }),

    sample_refs: z
      .array(z.union([stixArtifactType, stixFileType]))
      .min(1, { error: emptyStixListErrorMessage })
      .optional()
      .register(z.globalRegistry, {
        description:
          'The sample_refs property specifies a list of identifiers of the SCO file or artifact objects associated with this malware instance(s) or family.',
        usage: 'unused',
        status: 'inherit',
        examples: [],
      }),

    operating_system_refs: z
      .array(createMultiStixTypeValidator(['malware', 'tool']))
      .min(1, { error: emptyStixListErrorMessage })
      .optional()
      .register(z.globalRegistry, {
        description:
          'The operating systems that the malware family or malware instance is executable on. This applies to virtualized operating systems as well as those running on bare metal.\n\nThe value of this property MUST be the identifier for a SCO software object.',
        usage: 'unused',
        status: 'inherit',
        examples: [],
      }),
  })
  .strict()
  .check((ctx) => {
    createFirstAliasRefinement()(ctx);
    createFirstXMitreAliasRefinement()(ctx);
  });

export type Malware = z.infer<typeof malwareSchema>;
